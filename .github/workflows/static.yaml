---
name: Build binary releases

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  GOTOOLCHAIN: local

jobs:
  build-mac:
    permissions:
      contents: write
      id-token: write
      attestations: write
    strategy:
      fail-fast: false
      matrix:
        platform: ["arm64"]
    name: Build macOS ${{ matrix.platform }} binaries
    runs-on: ${{ matrix.platform == 'arm64' && 'macos-15' || 'macos-15-intel' }}
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache-dependency-path: |
            go.sum
            caddy/go.sum
          cache: false
      - name: Build FrankenPHP
        run: ./build-static.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE: ${{ '' }}
          NO_COMPRESS: ${{ '' }}
      - name: Upload artifact
        if: github.ref_type == 'branch'
        uses: actions/upload-artifact@v5
        with:
          name: frankenphp-mac-${{ matrix.platform }}
          path: dist/frankenphp-mac-${{ matrix.platform }}